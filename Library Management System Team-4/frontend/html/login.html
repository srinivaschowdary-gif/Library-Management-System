<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Form</title>
    <style>
         *{
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body{
   width: 100vw;
   height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-family: Arial,sans-serif;
    background-image: url(https://media.istockphoto.com/id/949118068/photo/books.jpg?s=612x612&w=0&k=20&c=1vbRHaA_aOl9tLIy6P2UANqQ27KQ_gSF-BH0sUjQ730=); 
    background-repeat: no-repeat;
    background-size: cover;
   background-position: center;
}
 .login-form{
        background: white;
        align-items: center;
        padding: 30px 30px;
        box-shadow: 0px 4px 15px slateblue;
        border-radius: 10px;
        width: 350px;
        height: 300px;
 }

 .login-form style{
   height: fit-content;
 }
  h2{
    font-size: 35px;
    margin-bottom: 30px;
    color: white;
 }
 .input{
    padding-top: 15px;
    gap: 2rem;
 }
 .input input{
    width: 100%;
    padding: 0.6rem;
    margin: 10px 0;
    border-radius: 3px;
    border: 1px solid #ccc;
 }
 .button{
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    margin: 1.5rem;
 }

 .button button{
    width: 110px;
    height: 30px;
    margin: 2px;
    border-radius: 3px;
    font-size: 18px;
 }

 .submit-btn{
    background-color: rgb(43, 43, 206);
    color: white;
    border-color: rgb(43, 43, 206);
 }

 .register-btn{
    border: 1px solid #ccc
 }


 .register-form{
        display: none;
        background: white;
        align-items: center;
        padding: 30px 40px;
        box-shadow: 0px 4px 15px rgba(0, 0, 0,2);
        border-radius: 10px;
        width: 380px;
        height: 350px;
 }

 .register-form h2{
    padding-left: 80px;
    color: black;
    font-size: 2rem;
 }

.register-form input{
    width: 100%;
    padding: 10px;
    margin: 5px;
    border-radius: 3px;
    border: 1px solid #ccc;
}

.register-form button{
    width: 100%;
    padding: 5px;
    margin: 5px;
    font-size: large;
    border-radius: 3px;
    color: white;
    background-color: rgb(43, 43, 206);
    border-color: rgb(43, 43, 206);;
}

.register-form p{
    padding: 15px;
    margin: 5px;
}

.register-form a{
    text-decoration: none;
}

    </style>
</head>
<body>
    <h2>LibraryManagementSystem</h2>
    
    <!-- Login Form -->
    <div class="login-form" id="login-form">
        <form>
            <div class="input">
                <label for="email">Email:</label>
                <input type="email" name="email" id="email" placeholder="Enter email" required><br>
                <label for="password">Password:</label>
                <input type="password" name="password" id="password" placeholder="Enter password" required><br>
            </div>
            <div class="button" style="overflow: auto;">
                <button type="submit" class="submit-btn">Submit</button>
                <button type="button" onclick="showregister()" id="show-register">Register</button>
            </div>
        </form>
    </div>
    
    <!-- Register Form -->
    <div class="register-form" id="register-form" style="display: none;">
        <h2>Register</h2>
        <form>
            <input type="text" name="username" id="reg-username" placeholder="Username" required><br>
            <input type="email" name="email" id="reg-email" placeholder="Email" required><br>
            <input type="password" name="password" id="reg-password" placeholder="Password" required><br>
            
            <!-- CRITICAL: Role Selection sent to the Java backend -->
            <select name="role" id="reg-role" required>
                <option value="" disabled selected>Select Role</option>
                <option value="Student">Student</option>
                <option value="Librarian">Librarian</option>
            </select><br>
            
            <button type="submit">Register</button><br>
            <p>Already registered? <a href="#" id="showlogin" onclick="showlogin()">Login Here</a></p>
        </form>
    </div>
   <script>
    // âœ… Form toggle functions (critical fix)
function showregister() {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'block';
}

function showlogin() {
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('login-form').style.display = 'block';
}

// âœ… Main logic
window.onload = function() {
    document.getElementById("register-form").style.display = "none";

    const loginForm = document.querySelector('#login-form form');
    const registerForm = document.querySelector('#register-form form');
    const API_BASE = 'http://localhost:8080/api/auth';

    // ðŸ”¹ LOGIN EVENT
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.querySelector('#login-form input[name="email"]').value.trim();
        const password = document.querySelector('#login-form input[name="password"]').value;

        try {
            const res = await fetch(`${API_BASE}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                alert(data.message + '\nWelcome ' + data.username);

                // Save user info locally
                localStorage.setItem('userId', data.id);
                localStorage.setItem('role', data.role);
                localStorage.setItem('username', data.username);
                localStorage.setItem('email', data.email);

                // Redirect based on role
                if (data.role === "Librarian") {
                    window.location.href = "managebook.html";
                } else {
                    window.location.href = "main.html";
                }
            } else {
                alert(data.message || 'Invalid email or password.');
            }
        } catch (err) {
            console.error('Login Fetch Error:', err);
            alert('Could not reach server. Please ensure your Java backend is running on port 8080.');
        }
    });

    // ðŸ”¹ REGISTER EVENT
    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.querySelector('#reg-username').value.trim();
        const email = document.querySelector('#reg-email').value.trim();
        const password = document.querySelector('#reg-password').value;
        const role = document.getElementById('reg-role').value;

        if (!role) {
            alert('Please select a role (Student or Librarian) before registering.');
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email, password, role })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                alert((data.message || 'Registered successfully!') + '\nYou can now login as ' + role + '.');
                showlogin(); // Go back to login form
            } else {
                alert(data.message || 'Registration failed. Please try again.');
            }
        } catch (err) {
            console.error('Registration Fetch Error:', err);
            alert('Could not reach server. Please ensure your Java backend is running on port 8080.');
        }
    });
};

   </script>
</body>
</html>